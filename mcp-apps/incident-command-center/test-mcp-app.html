<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP App Test Environment</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-header {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .test-header h1 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .test-info {
      color: #666;
      font-size: 14px;
    }
    .app-frame {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      background: white;
      min-height: 600px;
    }
    .reload-btn {
      background: #048a24;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .reload-btn:hover {
      background: #036818;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-header">
      <h1>üß™ Incident Command Center - Test Environment</h1>
      <div class="test-info">
        <p><strong>Status:</strong> Development Mode with Mock Data</p>
        <p><strong>Quick Workflow:</strong> Edit src/ ‚Üí Run <code>npm run build</code> ‚Üí Click Reload below</p>
      </div>
      <button class="reload-btn" onclick="location.reload()">üîÑ Reload App</button>
    </div>

    <div id="app-frame" class="app-frame"></div>
  </div>

  <script type="module">
    // Mock MCP Apps SDK
    const mockIncidents = [
      {
        id: 'PINCIDENT1',
        incident_number: 12345,
        title: 'API Gateway Timeout - Production',
        status: 'triggered',
        urgency: 'high',
        created_at: new Date(Date.now() - 3600000).toISOString(),
        service: { summary: 'API Gateway Service', id: 'PSVC001' },
        assignments: [{
          assignee: { summary: 'John Doe', id: 'PUSER001' }
        }],
        alert_counts: { triggered: 5, resolved: 2 },
        description: 'Multiple API gateway timeout errors detected. Runbook: https://wiki.company.com/runbooks/api-gateway-timeouts'
      },
      {
        id: 'PINCIDENT2',
        incident_number: 12346,
        title: 'Database Connection Pool Exhausted',
        status: 'acknowledged',
        urgency: 'high',
        created_at: new Date(Date.now() - 7200000).toISOString(),
        service: { summary: 'Database Service', id: 'PSVC002' },
        assignments: [{
          assignee: { summary: 'Jane Smith', id: 'PUSER002' }
        }],
        alert_counts: { triggered: 3, resolved: 10 },
        description: 'Connection pool exhaustion causing degraded performance'
      },
      {
        id: 'PINCIDENT3',
        incident_number: 12347,
        title: 'Memory Leak Detected',
        status: 'resolved',
        urgency: 'low',
        created_at: new Date(Date.now() - 86400000).toISOString(),
        service: { summary: 'Web Application', id: 'PSVC003' },
        assignments: [],
        alert_counts: { triggered: 0, resolved: 15 },
        description: 'Memory leak fixed and deployed'
      }
    ];

    const mockIncidentDetails = {
      'PINCIDENT1': {
        incident: mockIncidents[0],
        alerts: [
          {
            id: 'PALERT1',
            summary: 'API Gateway 504 Timeout',
            status: 'triggered',
            severity: 'error',
            created_at: new Date(Date.now() - 3600000).toISOString(),
            body: {
              details: 'Request to /api/v1/users timeout after 30s\nStack trace: at ApiGateway.handleRequest (src/gateway/handler.ts:145)\n  at Router.process (src/router.ts:89)',
              cef_details: {
                severity: 'error',
                source_component: 'api-gateway',
                file_path: 'src/gateway/handler.ts',
                line_number: 145
              }
            }
          },
          {
            id: 'PALERT2',
            summary: 'API Gateway High Latency',
            status: 'triggered',
            severity: 'warning',
            created_at: new Date(Date.now() - 1800000).toISOString(),
            body: {
              details: 'P95 latency increased to 5000ms',
              cef_details: {
                severity: 'warning'
              }
            }
          }
        ],
        notes: [
          {
            id: 'NOTE1',
            content: 'Investigating timeout issues. Checking backend service health.',
            created_at: new Date(Date.now() - 3000000).toISOString(),
            user: { summary: 'John Doe' }
          },
          {
            id: 'NOTE2',
            content: 'Backend service appears healthy. Checking database connections.',
            created_at: new Date(Date.now() - 2700000).toISOString(),
            user: { summary: 'John Doe' }
          }
        ],
        changes: [
          {
            id: 'CHANGE1',
            summary: 'Incident escalated to Tier 2',
            timestamp: new Date(Date.now() - 2400000).toISOString()
          }
        ]
      }
    };

    // Mock MCP App interface
    class MockApp {
      constructor() {
        this.context = {
          containerDimensions: { height: 600, width: 1200 }
        };
      }

      async callTool(params) {
        console.log('[Mock] callTool:', params);

        if (params.name === 'list_incidents') {
          return {
            isError: false,
            content: [{
              type: 'text',
              text: JSON.stringify({ incidents: mockIncidents })
            }]
          };
        }

        if (params.name === 'get_incident') {
          const incidentId = params.arguments?.incident_id;
          const details = mockIncidentDetails[incidentId] || mockIncidentDetails['PINCIDENT1'];
          return {
            isError: false,
            content: [{
              type: 'text',
              text: JSON.stringify(details)
            }]
          };
        }

        if (params.name === 'acknowledge_incident' || params.name === 'resolve_incident') {
          return {
            isError: false,
            content: [{ type: 'text', text: JSON.stringify({ success: true }) }]
          };
        }

        return {
          isError: true,
          content: [{ type: 'text', text: 'Mock tool not implemented' }]
        };
      }

      async updateModelContext(params) {
        console.log('[Mock] updateModelContext called with:', params);
        return Promise.resolve();
      }

      async sendMessage(params) {
        console.log('[Mock] sendMessage called with:', params);
        alert('Mock: Would send message to model:\n\n' + JSON.stringify(params.content[0].text.substring(0, 200) + '...', null, 2));
        return Promise.resolve();
      }

      async notification(params) {
        console.log('[Mock] notification:', params);
        return Promise.resolve();
      }
    }

    // Create global mock app instance
    window.__mockApp = new MockApp();

    // Load the built MCP app
    async function loadApp() {
      try {
        const response = await fetch('/mcp-app.html');
        if (!response.ok) {
          throw new Error('Failed to load app. Run: npm run build');
        }
        const html = await response.text();

        // Extract and inject the app content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Copy all scripts and styles
        const frame = document.getElementById('app-frame');
        const scripts = doc.querySelectorAll('script');
        const styles = doc.querySelectorAll('style');

        // Inject styles
        styles.forEach(style => {
          frame.appendChild(style.cloneNode(true));
        });

        // Create root element
        const root = document.createElement('div');
        root.id = 'root';
        frame.appendChild(root);

        // Inject scripts
        scripts.forEach(script => {
          const newScript = document.createElement('script');
          if (script.src) {
            newScript.src = script.src;
          } else {
            // Replace MCP Apps SDK imports with mock
            let code = script.textContent || '';
            code = code.replace(
              /import\s+{[^}]*}\s+from\s+["']@modelcontextprotocol\/ext-apps["'];?/g,
              ''
            );
            code = code.replace(
              /const\s+app\s*=\s*useApp\(\);?/g,
              'const app = window.__mockApp;'
            );
            newScript.textContent = code;
          }
          if (script.type) newScript.type = script.type;
          frame.appendChild(newScript);
        });

        console.log('‚úÖ MCP App loaded successfully');
      } catch (error) {
        document.getElementById('app-frame').innerHTML = `
          <div style="padding: 40px; text-align: center; color: #d32f2f;">
            <h2>‚ùå Failed to load app</h2>
            <p>${error.message}</p>
            <p style="margin-top: 20px;">
              <strong>Run this command:</strong><br>
              <code style="background: #f5f5f5; padding: 10px; display: inline-block; margin-top: 10px;">npm run build</code>
            </p>
          </div>
        `;
      }
    }

    loadApp();
  </script>
</body>
</html>
